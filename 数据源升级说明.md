# 数据源升级说明

## 📋 问题描述

原回测系统配置为 **2015-2025** 年，但实际数据只有 **2023-2025** 年（约 2.5 年）。

**原因**: 腾讯财经 API 只提供最近 2-3 年的免费历史数据。

## ✅ 解决方案

### 新增数据源

已添加 **新浪财经数据源**（通过 akshare `stock_zh_a_daily`）：
- ✓ 支持从 **1991 年**至今的完整历史数据
- ✓ 数据稳定可靠
- ✓ 完全覆盖 2015-2025 年回测需求

### 数据源优先级

修改后的数据获取顺序：

1. **新浪财经** - 主要数据源（1991-至今，完整历史数据）
2. **东财** - 备用（可能被限流）
3. **腾讯** - 最后备用（仅 2-3 年数据）

## 📊 测试结果

测试股票：000001（平安银行）
- ✓ 获取数据量: **2674 条**
- ✓ 日期范围: **2015-01-05 ~ 2025-12-31**
- ✓ 覆盖年份: **完整 11 年**

```
包含的年份: [2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024, 2025]
```

## 🔧 修改内容

### 文件修改

**data_fetcher.py**:
1. 新增 `_fetch_kline_sina()` 方法 - 从新浪获取数据
2. 修改 `get_stock_daily_data()` - 调整数据源优先级
3. 更新注释说明

### 缓存清理

- ✓ 已清理所有旧缓存文件（3292 个）
- ✓ 系统将在下次回测时自动获取完整历史数据

## 🚀 使用说明

### 开始新的回测

1. **前端创建回测任务**:
   - 开始日期：2015-01-01
   - 结束日期：2025-12-31
   - 系统会自动使用新浪数据源获取完整数据

2. **或使用配置文件默认值**:
   ```python
   # config.py
   START_DATE = "2015-01-01"  # ✓ 现在可以使用完整的 2015 年开始
   END_DATE = "2025-12-31"
   ```

### 数据获取性能

- 首次获取会较慢（需要下载并缓存数据）
- 后续回测会使用缓存，速度大幅提升
- 建议首次运行选择少量股票测试

## ⚠️ 注意事项

1. **网络要求**: 新浪数据源不需要特殊代理配置
2. **数据延迟**: 约 0.3 秒/股票（避免请求过快）
3. **缓存位置**: `./data_cache/` 目录
4. **交易日历**: 数据仅包含交易日，休市日自动跳过

## 📝 版本信息

- 修改日期: 2026-02-08
- akshare 版本: 1.18.22
- Python 版本: 3.13

## 🎯 下一步

现在你可以：
1. 运行 2015-2025 完整回测
2. 对比不同年份的策略表现
3. 分析长期历史数据的回测结果

---

**测试命令**:
```bash
# 测试数据获取
venv/bin/python test_new_datasource.py

# 运行回测（示例）
# 在前端界面创建回测任务，或使用 Python 脚本
```
