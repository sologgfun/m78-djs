# 股票名称显示Bug修复说明

## 📋 问题描述

在回测多只股票时，统计结果详情中：
- ✗ **部分股票只显示代码**（如：600000）
- ✓ **部分股票能显示名称**（如：德明利）

**示例**: 浦发银行和德明利一起回测时，浦发银行只显示代码 600000

## 🔍 问题原因

1. **批量获取基本面数据时**，东财 API 返回的 `f14` (stock_name) 字段有时为空
2. **单个补全逻辑**依赖 `get_stock_fundamental` 方法，但该方法可能因网络/代理问题失败
3. **缺少fallback机制**，导致名称为空时无法从其他数据源获取

## ✅ 修复方案

### 1. 增强批量获取的名称处理

**文件**: `data_fetcher.py` → `_fetch_batch_fundamentals()`

```python
# 确保 stock_name 列存在
if "stock_name" not in df.columns:
    df["stock_name"] = ""
else:
    df["stock_name"] = df["stock_name"].fillna("").astype(str).str.strip()

# 对于名称为空的股票，从缓存补全
empty_name_mask = (df["stock_name"] == "") | (df["stock_name"] == df["stock_code"])
if empty_name_mask.any():
    # 从 stock_list.csv 缓存获取名称
    ...
```

### 2. 改进单个获取的fallback机制

**文件**: `data_fetcher.py` → `get_stock_fundamental()`

```python
except Exception as e:
    # 东财失败时，从缓存获取股票名称
    name = self._get_stock_name_from_cache(stock_code)
    if name:
        return {
            "stock_code": stock_code,
            "stock_name": name,
            ...
        }
```

### 3. 增强回测引擎的名称补全

**文件**: `backtest_engine.py` → `load_data()`

```python
# 检查名称是否有效（非空、非代码本身）
if name and isinstance(name, str) and name.strip() and name != code:
    self.name_map[code] = name.strip()

# 补全逻辑：检查名称为空或无效的情况
missing_names = [c for c in stock_codes if c not in self.name_map or not self.name_map[c]]
```

### 4. 增强名称查找方法

**文件**: `backtest_engine.py` → `_lookup_stock_name()`

```python
def _lookup_stock_name(self, stock_code: str) -> str:
    # 1. 从预加载的名称映射表查找
    # 2. 从基本面数据查找
    # 3. 实时获取（作为最后手段）
    # 4. 回退为代码
```

## 🧪 测试结果

### 修复前
```
✗ 600000: '' (浦发银行 - 只显示代码)
✓ 000001: '平安银行'
✗ 600036: '' (招商银行 - 只显示代码)
```

### 修复后
```
✓ 600000: '浦发银行'
✓ 000001: '平安银行'  
✓ 600036: '招商银行'
✓ 601398: '工商银行'
```

**所有测试通过！** ✓✓✓✓

## 📊 修复效果

1. **批量获取**: 东财 API 返回的名称自动补全
2. **单个获取**: 失败时从缓存获取名称
3. **回测引擎**: 多层fallback确保名称可用
4. **实时获取**: 最后手段，避免遗漏

## 🔧 相关文件

- `data_fetcher.py` - 数据获取模块
- `backtest_engine.py` - 回测引擎
- `data_cache/stock_list.csv` - 股票列表缓存（名称来源）

## 📝 使用说明

### 自动处理

修复后，系统会自动：
1. 尝试从批量 API 获取名称
2. 失败时从缓存补全
3. 仍失败时实时获取
4. 最后回退为代码

### 手动维护（可选）

如果发现仍有股票名称缺失，可以手动更新 `data_cache/stock_list.csv`:

```csv
code,name,market
600000,浦发银行,SH
000001,平安银行,SZ
...
```

## ⚠️ 注意事项

1. **首次运行**: 如果 `stock_list.csv` 不存在，系统会尝试自动生成（较慢）
2. **缓存更新**: 定期更新股票列表缓存，确保新股名称可用
3. **网络问题**: 如果东财 API 持续失败，确保网络/代理配置正常

## 🎯 未来优化

1. 优化 `get_stock_list()` 性能
2. 添加更多数据源作为fallback
3. 实现名称的增量更新机制

---

**修复日期**: 2026-02-08  
**测试状态**: ✓ 通过  
**影响范围**: 所有回测任务的股票名称显示
